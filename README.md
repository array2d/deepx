# deepx

## 一.deepx概述
deepx一种以统一存算面为底座的深度学习训推框架,模型函数可以通过简单的数学形式进行表达为计算图，计算图可以写入到统一存算面的存储空间，被统一存算面的调度执行器自动执行。

## 二.统一存算面
统一存算面是一个分布式tensor计算解释器。
统一存算面把分布式的gpu集群，抽象为统一的计算与存储平面，具体而言，就是存储了tensor元信息、计算图。但存算面本身，目前只利用了redis的kv功能。tensor的真正存储依然在gpu显存、内存、磁盘上，真正的计算，也是由执行器进程通过gpu/cpu去进行计算。但统一存算面的作用在于，抽象了tensor相关的计算图与存储表示，为tensor编程，开辟了新的上层表达语言，从而可以完全和复杂的底层工程代码隔离。

deepx的分前端与统一存算面（中端与后端），分别是为前端表达侧，编译替换调度层，执行器层，遵守严格的进程间与代码组件的隔离，以保证分工明确，架构长久稳定。

+ 前端/模型表达侧，交由算法工程师、用接近数学的表达方式，设计其数学计算过程。只表示为单线程的简洁数学表达过程，不涉及复杂的device类型、分布式等。
+ 统一存算面：通过统一的kv寻址空间，把分散的gpu算力与tensor映射到映射。
  * 调度层：编译替换与分布式调度层：注册了多轮不同类型的IR编译器，实现等价替换，可以以插件的形式增加自定义能力如定制kvcache，实现对计算图进行局部替换，获得新的能力。
  * 执行器层：绑定具体的加速硬件，实现真正的tensor的储存、计算、网络通信，大规模并行化。


## 三.前端

tensor相关的函数表达式，和pytorch/numpy的api很像
deepx会输出计算图的IR序列,方便传递给统一存算面


## 四.统一存算面
中端：编译替换与分布式调度层

+ 
  * 当前采用redis存储tensor元信息，配合heapmem进程，负责管理堆tensor的生命周期
+ 统一计算面
  * 收集当前已就绪的执行器的算子列表,收集算子时耗和空间占用信息
  * 计算图编译器优化器:fusion算子，计算图节点消除,自动生成tensor拆分并行的计算子图并替代原节点
  + front生成基础IR，编译器负责进行fusion成executor注册的高级算子。
+ 统一控制面
  * 执行调度器：数据并行，流水线并行(前向反向并行)，模型并行。

### 执行层

执行层包括op和heapmem两类执行器。

#### heapmem管理器

heapmem管理的tensor，通常是持久的权重，可能被很多个不同进程访问，。
相对应的，随着函数执行完毕自动回收的中间变量tensor，可以被称之为stacktensor，这些tensor交给op进程自行管理。

#### op执行器

负责算子计算操作，以IR为执行的核心单元
```
Op{args(args_grad),returns(returns_grad)|func run}
```

Op需要实现run方法

关于executor，只要能按deepxIR序列执行，并返回结果，就可以接入deepx分布式调度框架，因此，从硬件、指令、加速库、高级框架包括训练、推理引擎，都可以稍作修改，就接入deepx体系。
 
+ cpu执行器
已实现ompsimd。其支持的算子列表[ompsimd](docs/executor/op-mem-ompsimd/list.md)

+ cuda执行器
其支持的算子列表[cuda](docs/executor/op-mem-cuda/list.md)

欢迎大家提交cuda代码

+ rocm
+ apple
+ 其他硬件加速器

#### 张量计算框架or函数级执行器

DeepX可以集成现有的张量计算框架作为执行器，充分利用现有生态系统的优化能力:

+ jax: 
  - 结合DeepX的分布式调度，使JAX代码自动获得分布式执行能力
  - 支持异构设备(GPU/TPU)加速的同时保持DeepX的分布式弹性扩展

+ LibTorch/aten: 
  - 可将PyTorch生态系统的算子作为DeepX执行器
  - 利用ATEN底层优化的同时享受DeepX分布式调度的优势

这种架构使得DeepX可以整合各类先进的计算框架作为执行引擎，同时提供统一的分布式调度和执行能力，为用户提供更灵活的选择和更高的性能。

 
 ### 官方文档
 
 [https://deepx.array2d.com](https://deepx.array2d.com)

商业支持：lipeng@mirrorsoft.cn

###  开源协议
本项目采用**Apache License 2.0**协议

- 允许商用和修改分发
- 需保留版权声明
- 修改文件需在头注释说明变更
- 不提供任何明示担保

完整协议见：[LICENSE](LICENSE)
